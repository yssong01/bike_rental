<!-- [JS 연습] JavaScript API + 지도 시각화 -->
<!-- fetch를 이용해 “서울시 공공자전거 실시간 대여정보(Open API)”를 불러오고, 해당 데이터를 활용해 카카오맵에 대여소 위치와 재고 수량을 표시하는 웹페이지 만들기 -->

<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>서울시 공공자전거 실시간 지도</title>
    <style>
      body {
        font-family: sans-serif;
        padding: 1.5rem;
      }
      h2 {
        margin-top: 0;
      }
      button {
        font-size: 1rem;
        padding: 0.4rem 0.9rem;
        margin-left: 0.5rem;
      }

      #map {
        width: 100%;
        height: 1000px;
        margin-top: 1rem;
        border: 1px solid #ccc;
      }

      #status {
        margin-top: 0.5rem;
        font-size: 0.9rem;
        color: #555;
      }

      /* 작은 동그라미 마커 스타일 */
      .bike-marker {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        border: 2px solid #fff;
        box-sizing: border-box;
        box-shadow: 0 0 4px rgba(0, 0, 0, 0.4);
      }

      /* 대수에 따른 색상 */
      .level-0 {
        background-color: #e74c3c; /* 빨강: 0대 */
      }
      .level-1 {
        background-color: #e67e22; /* 주황: 1~4대 */
      }
      .level-2 {
        background-color: #2ecc71; /* 초록: 5대 이상 */
      }

      /* 인포윈도우 안쪽 스타일 */
      .bike-info {
        max-width: 230px; /* 너무 넓어지지 않도록 제한 */
        padding: 6px 8px;
        font-size: 13px;
        line-height: 1.4;
        background: rgba(255, 255, 200, 0.9); /* 옅은 노랑 반투명 */
        border-radius: 8px; /* 모서리 둥글게 */
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.25);
        white-space: normal; /* 여러 줄 허용 */
        word-break: break-all; /* 한글/긴 문자열도 줄바꿈 허용 ← 핵심 수정 */
      }

      /* InfoWindow 기본 wrapper 테두리 제거 + 둥글게 */
      div.info,
      div.wrap,
      div.iw_inner,
      div.balloon,
      div.inner,
      .wrap,
      .info,
      .iw_inner,
      .balloon,
      .inner {
        border: none !important; /* 기본 검은/회색 테두리 제거 */
        background: transparent !important; /* 기본 하얀 배경 제거 */
        box-shadow: none !important; /* 기본 그림자 제거 */
        border-radius: 0 !important; /* 둥근 모서리는 bike-info에서 처리 */
        overflow: visible !important;
      }

      .bike-info-title {
        font-weight: bold;
        margin-bottom: 4px;
      }

      /* 범례(legend) */
      .legend {
        margin-top: 0.7rem;
        font-size: 0.9rem;
      }
      .legend-item {
        display: inline-flex;
        align-items: center;
        margin-right: 1rem;
      }
      .legend-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 4px;
        border: 1px solid #fff;
        box-shadow: 0 0 2px rgba(0, 0, 0, 0.4);
      }
      .legend-dot.level-0 {
        background-color: #e74c3c;
      }
      .legend-dot.level-1 {
        background-color: #e67e22;
      }
      .legend-dot.level-2 {
        background-color: #2ecc71;
      }
    </style>
  </head>
  <body>
    <h2>서울시 공공자전거 실시간 대여 현황</h2>
    <p>
      <strong>따릉이 자전기 실시간 위치 및 재고 수량 지도</strong> (카카오맵 +
      서울시 공공자전거 실시간 대여 정보 API활용)
    </p>

    <button id="loadBtn" onclick="loadBikeData()">데이터 불러오기</button>
    <span id="status">버튼을 눌러서 데이터를 불러오세요.</span>

    <div class="legend">
      <span class="legend-item">
        <span class="legend-dot level-0"></span> 0대
      </span>
      <span class="legend-item">
        <span class="legend-dot level-1"></span> 1~4대
      </span>
      <span class="legend-item">
        <span class="legend-dot level-2"></span> 5대 이상
      </span>
    </div>

    <div id="map"></div>

    <!-- 1) Kakao JS 키를 담은 config.js 로드 -->
    <script src="./js/config.js"></script>

    <!-- 2) config.js 에서 불러온 키로 Kakao Maps SDK를 동적으로 로드 -->
    <script>
      if (!window.KAKAO_JS_KEY) {
        console.error(
          "KAKAO_JS_KEY가 정의되어 있지 않습니다. js/config.js를 확인하세요."
        );
      } else {
        document.write(`
          <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=${window.KAKAO_JS_KEY}&libraries=clusterer"><\/script>
        `);
      }
    </script>

    <!-- 3) 기존 메인 스크립트 (지도, 마커, 클러스터링 등) -->
    <script>
      // -----------------------------------------------------
      // 1. 공공데이터 프록시 API 설정 (Vercel)
      // -----------------------------------------------------
      const PROXY_BASE_URL = "https://bike-rental-drab-eta.vercel.app/api/bike";

      let map;
      let clusterer;
      let markers = [];
      let currentInfoWindow = null;

      const statusEl = document.getElementById("status");

      // -----------------------------------------------------
      // 2. 마커 색상 / 이미지 설정
      // -----------------------------------------------------

      // 자전거 대수에 따라 색 구분 키 반환
      function getLevelKey(count) {
        const n = Number(count);
        if (n === 0) return "level0"; // 빨강
        if (n <= 4) return "level1"; // 주황
        return "level2"; // 초록
      }

      // 원형 SVG를 data URL로 만들어주는 함수
      function createCircleSvgDataUrl(color) {
        const svg = `
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18">
        <circle cx="9" cy="9" r="7" fill="${color}" stroke="white" stroke-width="2" />
      </svg>`;
        return "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg);
      }

      // 색상별 MarkerImage를 미리 만들어 둔다
      const markerImages = {};
      function initMarkerImages() {
        const size = new kakao.maps.Size(18, 18);
        const options = { offset: new kakao.maps.Point(9, 9) };

        markerImages.level0 = new kakao.maps.MarkerImage(
          createCircleSvgDataUrl("#e74c3c"), // 0대: 빨강
          size,
          options
        );
        markerImages.level1 = new kakao.maps.MarkerImage(
          createCircleSvgDataUrl("#e67e22"), // 1~4대: 주황
          size,
          options
        );
        markerImages.level2 = new kakao.maps.MarkerImage(
          createCircleSvgDataUrl("#2ecc71"), // 5대 이상: 초록
          size,
          options
        );
      }

      // -----------------------------------------------------
      // 3. 인포윈도우
      // -----------------------------------------------------
      function showInfoWindow(marker, rowData) {
        if (currentInfoWindow) {
          currentInfoWindow.close();
        }

        const content = `
          <div class="bike-info">
            <div class="bike-info-title">${rowData.stationName}</div>
            <div>자전거 거치대 수: ${rowData.rackTotCnt}개</div>
            <div>이용 가능한 수: ${rowData.parkingBikeTotCnt}대</div>
            <div>거치율: ${rowData.shared}%</div>
          </div>
        `;

        currentInfoWindow = new kakao.maps.InfoWindow({
          position: marker.getPosition(),
          content,
        });

        currentInfoWindow.open(map, marker);
      }

      // -----------------------------------------------------
      // 4. 마커 / 클러스터 관리
      // -----------------------------------------------------
      function clearMarkers() {
        if (clusterer) clusterer.clear();
        markers.forEach((m) => m.setMap(null));
        markers = [];
      }

      // #------------------------------------------------------
      // 4-1. 서버(Vercel)에서 이미 전체 데이터를 모아서 내려주므로 프론트에서는 한 번만 호출하면 됨
      // 여러 페이지(1~1000, 1001~2000, …) 전체 데이터 불러오기
      async function fetchAllBikeData() {
        const url = PROXY_BASE_URL; // start/end 필요 없음

        console.log("요청:", url);

        const res = await fetch(url);
        const data = await res.json();

        // Vercel의 api/bike.js 가 { total, rows } 형태로 응답함
        if (!data.rows || data.rows.length === 0) {
          console.log("응답 rows가 비어 있습니다.");
          return [];
        }

        console.log("총 로드된 대여소 수:", data.total);
        return data.rows; // rows 배열만 돌려줌
      }

      // -----------------------------------------------------
      // 5. 데이터 불러오기 + 마커 생성 (버튼 onclick에서 호출)
      // -----------------------------------------------------
      async function loadBikeData() {
        statusEl.innerText = "데이터 불러오는 중...";

        try {
          const rows = await fetchAllBikeData(); // ★ 여기서 전체 페이지 데이터를 한 번에 받음

          statusEl.innerText = `대여소 ${rows.length}개 로드 완료`;

          clearMarkers();
          const bounds = new kakao.maps.LatLngBounds();

          rows.forEach((row) => {
            const lat = parseFloat(row.stationLatitude);
            const lng = parseFloat(row.stationLongitude);
            if (Number.isNaN(lat) || Number.isNaN(lng)) return;

            const position = new kakao.maps.LatLng(lat, lng);
            bounds.extend(position);

            const levelKey = getLevelKey(row.parkingBikeTotCnt);
            const image = markerImages[levelKey];

            const marker = new kakao.maps.Marker({
              position,
              image,
            });

            kakao.maps.event.addListener(marker, "click", () =>
              showInfoWindow(marker, row)
            );

            markers.push(marker);
          });

          if (markers.length > 0) {
            clusterer.addMarkers(markers);
            map.setBounds(bounds);
          }
        } catch (err) {
          console.error("데이터 로드 실패:", err);
          statusEl.innerText = "데이터 불러오기 실패 (콘솔 확인)";
        }
      }

      // -----------------------------------------------------
      // 6. 초기화 (지도 + 클러스터러 생성)
      // -----------------------------------------------------
      window.onload = function () {
        if (!window.kakao || !window.kakao.maps) {
          console.error("카카오 지도 SDK 로딩 실패");
          return;
        }

        const container = document.getElementById("map");
        const options = {
          center: new kakao.maps.LatLng(37.5665, 126.978), // 서울 시청 근처
          level: 7,
        };
        map = new kakao.maps.Map(container, options);

        clusterer = new kakao.maps.MarkerClusterer({
          map,
          averageCenter: true,
          minLevel: 7, // 7보다 작게(줌인) 되면 개별 마커로 풀림
        });

        initMarkerImages(); // 색깔 마커 준비
        console.log("지도/클러스터러 초기화 완료");
      };
    </script>
  </body>
</html>
